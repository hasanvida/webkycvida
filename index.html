<!DOCTYPE html>
<html>
<head>
  <title>Vida Web SDK Debug Demo</title>
  <script src="https://web-sdk.vida.id/1.1.0/sandbox/vida-web-sdk.js"></script>
  <style>
    body { font-family: Arial; padding: 40px; background: #f4f6f9; }
    button {
      padding: 10px 18px;
      margin-right: 10px;
      margin-bottom: 10px;
      background: #0d6efd;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #sdk-container { margin-top: 20px; }
    #log-box {
      margin-top: 20px;
      background: #111;
      color: #0f0;
      padding: 15px;
      border-radius: 6px;
      font-size: 12px;
      height: 250px;
      overflow: auto;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>

<h2>Vida Web SDK Debug (Sandbox)</h2>

<button onclick="startFull()">Start Identity Verification</button>

<div id="sdk-container"></div>
<div id="log-box"></div>

<script>

function log(message) {
  console.log(message);
  const logBox = document.getElementById("log-box");
  logBox.innerHTML += message + "\n";
  logBox.scrollTop = logBox.scrollHeight;
}

window.onload = function() {
  log("Page loaded");
  log("VidaSDK exists: " + !!window.VidaSDK);
};

async function getToken() {
  log("Fetching token from backend...");

  const response = await fetch("/.netlify/functions/get-token");

  log("Token API status: " + response.status);

  if (!response.ok) {
    throw new Error("Token API failed: " + response.status);
  }

  const data = await response.json();

  log("Token received");
  log("Token length: " + (data.access_token?.length || 0));
  log("Signing key exists: " + !!data.signing_key);

  if (!data.access_token) {
    throw new Error("access_token missing");
  }

  if (!data.signing_key) {
    throw new Error("signing_key missing");
  }

  return data;
}

async function initWorkflow() {
  try {
    log("Starting workflow: identity-verification");

    const container = document.getElementById("sdk-container");
    container.innerHTML = "";

    if (!window.VidaSDK) {
      log("ERROR: VidaSDK not loaded!");
      return;
    }

    const data = await getToken();

    log("Initializing SDK...");

    window.VidaSDK.init({
      token: data.access_token,           // ✅ Correct key
      signingKey: data.signing_key,       // ✅ Correct key
      elementId: "sdk-container",
      workflow: "identity-verification",  // ✅ Mandatory
      countryCode: "IDN",                 // ✅ Mandatory
      locale: "EN",
      partnerTransactionId: crypto.randomUUID(),

      workflowConfigs: {
        identityVerification: {
          userConsent: {
            obtained: true,
            obtainedAt: Date.now(),
          }
        }
      },

      onComplete: (result) => {
        log("Workflow Completed");
        log(JSON.stringify(result, null, 2));
      },

      onError: (error) => {
        log("Workflow Error:");
        log(JSON.stringify(error, null, 2));
      },
    });

    log("VidaSDK.init() executed");

  } catch (err) {
    log("Exception:");
    log(err.message);
  }
}

function startFull() {
  initWorkflow();
}

</script>

</body>
</html>
