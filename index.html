<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>VIDA Identity Verification Demo</title>

  <!-- ✅ CORRECT VIDA WEB SDK (Sandbox) -->
  <script src="https://web-sdk.vida.id/1.1.0/sandbox/vida-web-sdk.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 40px;
      background: #f4f6f9;
    }
    button {
      padding: 10px 18px;
      background: #0d6efd;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #sdk-container {
      margin-top: 20px;
    }
    #log-box {
      margin-top: 20px;
      background: #111;
      color: #0f0;
      padding: 12px;
      height: 220px;
      overflow: auto;
      font-size: 12px;
      white-space: pre-wrap;
      border-radius: 6px;
    }
  </style>
</head>

<body>

<h2>VIDA Identity Verification (Sandbox)</h2>

<button id="startBtn">Start Verification</button>

<div id="sdk-container"></div>
<div id="log-box"></div>

<script>
  function log(msg) {
    console.log(msg);
    const box = document.getElementById("log-box");
    box.innerHTML += msg + "\n";
    box.scrollTop = box.scrollHeight;
  }

  window.onload = function () {
    log("Page loaded");
    log("VidaSDK exists: " + !!window.VidaSDK);
  };

  document.getElementById("startBtn").addEventListener("click", async function () {
    try {
      log("=================================");
      log("Start button clicked");

      // 1️⃣ Get fresh token
      log("Calling /.netlify/functions/get-token");
      const res = await fetch("/.netlify/functions/get-token");
      const tokenData = await res.json();

      log("Token received");
      log("Token length: " + tokenData.access_token.length);

      // 2️⃣ Clear container
      document.getElementById("sdk-container").innerHTML = "";

      // 3️⃣ Init VIDA SDK (CORRECT WAY)
      log("Initializing VIDA SDK...");

      window.VidaSDK.init({
        token: tokenData.access_token,        // ✅ correct key
        signingKey: tokenData.signing_key,    // ✅ required
        elementId: "sdk-container",
        workflow: "identity-verification",
        countryCode: "IDN",
        locale: "EN",
        partnerTransactionId: crypto.randomUUID(),

        workflowConfigs: {
          identityVerification: {
            skipFaceMatch: true,
            userConsent: {
              obtained: true,
              obtainedAt: Date.now(),
            },
            docVerification: {
              skipDocBackSideCapture: true, // ✅ as requested
              maxRetryAttempts: 3,
            },
            faceMatch: {
              maxRetryAttempts: 3,
            }
          }
        },

        onComplete: (data) => {
          log("✅ VERIFICATION COMPLETED");
          log(JSON.stringify(data, null, 2));
        },

        onError: (error) => {
          log("❌ VERIFICATION ERROR");
          log(JSON.stringify(error, null, 2));
        }
      });

      log("VidaSDK.init() called");

    } catch (err) {
      log("❌ FATAL ERROR");
      log(err.message || err);
    }
  });
</script>

</body>
</html>
